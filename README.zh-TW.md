# GameMatchDemo

## 專案簡介

**GameMatchDemo是一個基於 C++ 開發並支援多執行緒的簡易遊戲匹配Demo專案，運行於 Windows 11 平台，使用 SQLite3 作為資料庫。**  
**它模擬了批次玩家加入匹配隊列、自動組隊、進入戰鬥、戰鬥結果處理及數據保存的流程。**
**用以展示實現一個匹配系統的核心邏輯、排程處裡、玩家數據管理、持久化儲存以及多執行緒併發處理等。**

---
### 專案演示

![啟動](images/demo/startup-1.png)
```
* 啟動執行檔
```
---
![指令 batch 演示](images/demo/batch-1.png)
```
* batch <[數量]> : 送出指定數量的隨機玩家進行匹配，預設1名。
```
---
![指令 join 演示](images/demo/join-1.png)
```
* join <id, [id_2, ...]> : 送出指定id(s)的玩家進行匹配。
```
---

![指令 queue 演示](images/demo/queue-2.png)
```
* queue : 顯示當前匹配隊列中的玩家，包含個人與隊伍。
```
---

![指令 top 演示](images/demo/top-1.png)
```
* top <[名次]> : 顯示指定名次的玩家資料，預設10名。
```
---

![指令 show 演示](images/demo/show-1.png)
```
* show <id, [id_2, ...]> : 顯示指定id(s)的玩家資料。
```
---

![指令 list 演示](images/demo/list-1.png)
```
* list : 顯示當前的所有玩家。
```
---

![指令 exit 演示](images/demo/exit-1.png)
```
* exit : 關閉Demo並釋放資源。
```
---

## 專案目標
作為個人編程能力和伺服器開發理解的Demo  
* 展示 C++ 多執行緒編程和同步機制，處理並發操作。  
* 核心邏輯包含玩家創建、狀態管理、分級匹配系統和資料庫讀寫。  
* 實現資料持久化，使用SQLite進行玩家資料的讀取和異步回寫。  
* 實現排程任務管理器，用於定時執行後台任務 (資料庫回寫) 。  
---
## 運行環境
要構建並運行此專案，請確保已安裝以下依賴項：

### 必需工具
- **Visual Studio 2022（或更新版本）**  
  - ✅ **C++ 開發工作負載**（`桌面開發（C++）`）  
  - ✅ **MSVC v143 編譯工具**（`v143 平台工具集`）  
  - ✅ **CMake**（如果專案需要）  
  - ✅ **Windows SDK**（最新版本）  

### 設置步驟
1. **如果尚未安裝 Visual Studio，請先安裝。**
2. **透過 Visual Studio Installer 修改安裝：**
   - 打開 **Visual Studio Installer**。
   - 選擇 **修改** → **工作負載** → ✅ **桌面開發（C++）**。
   - 在 **個別元件** 中確保已勾選 ✅ **MSVC v143**。
3. **克隆倉庫並在 Visual Studio 中開啟專案。**
4. **選擇正確的平台工具集：**
   - 右鍵專案 → **屬性** → **一般** → **平台工具集** → 設定為 `v143`。
5. **透過 `Ctrl + Shift + B` 或 **建置解決方案** 來編譯專案。
6. **確認安裝成功：**
   - 開啟輸出日誌，檢查是否有 **編譯錯誤**。
   - 執行可執行文件以確保成功編譯。

### 疑難排解
如果編譯失敗並顯示 **MSB8020（缺少 v143 編譯工具）**：
- **透過 Visual Studio Installer 確保已安裝 v143 編譯工具**。
- **檢查 Windows SDK 安裝是否完整**：
  - 打開 **Visual Studio Installer** → 進入 **個別元件** → **確認已選擇最新的 Windows SDK**。
- **嘗試重新啟動 Visual Studio 並重新編譯專案**。

---
## 核心功能

### 玩家管理 (PlayerManager)
* 玩家登入/登出機制。  
* 管理玩家的在線狀態和遊戲內狀態 (離線/匹配中/戰鬥中/大廳)。  
* 處理玩家戰鬥結果並更新分數和勝場。  
* 異步回寫 : 當玩家資料有變動時會加入排程，並定時回寫資料庫。  

### 戰鬥匹配管理 (BattleManager)
* 根據玩家階位 (Tier) 進行分級匹配。自動組隊機制 (3v3) 。  
* 創建獨立的戰鬥房間 (BattleRoom) 以及戰鬥單位英雄 (Hero) 。  
* 各房間獨立執行緒進行簡單模擬戰鬥與結果。  
* 戰鬥結束後的勝負判定和結果會同步。  

### 資料庫管理 (DbManager)
* 基於 SQLite 輕量化資料庫實現數據的持久化存儲。  
* 提供玩家戰鬥數據的增、刪、查、改介面。  
* 初始化時確保資料庫表結構必須存在並會將資料載入遊戲中。  

### 任務排程管理 (ScheduleManager)
* 通用的多執行緒安全的任務排程器。  
* 支持週期性任務 (ex. 玩家資料回寫) 和一次性任務。 
---

## 專案結構
```
 .
 ├── include/
 │   └── globalDefine.h          # 全域定義
 ├── libs/
 │   └── sqlite/                 # Sqlte資料庫
 │       ├── sqlite3.c
 │       └── sqlite3.h
 ├── src/
 │   ├── managers/
 │   │   ├── battleManager.cpp   # 戰鬥和匹配核心邏輯
 │   │   ├── battleManager.h
 │   │   ├── dbManager.cpp       # SQLite 數據庫操作介面
 │   │   ├── dbManager.h
 │   │   ├── playerManager.cpp   # 玩家數據管理
 │   │   ├── playerManager.h
 │   │   ├── scheduleManager.cpp # 定時任務排程器
 │   │   └── scheduleManager.h
 │   ├── objects/
 │   │   ├── hero.cpp            # 英雄類別
 │   │   ├── hero.h
 │   │   ├── player.cpp          # 玩家類別
 │   │   └── player.h
 │   └── main.cpp                # 應用程式入口，初始化管理器，處理用戶命令
 ├── utils/
 │  ├── utils.cpp                # 工具函式 (時間, 字串處理)
 │  └── utils.h
 ├── README.md
 └── README.zh-TW.md
```
---
## TODO List

此專案作為一個概念驗證的多執行緒伺服器應用範例，旨在展示核心的玩家管理、戰鬥匹配與數據持久化功能。
鑑於專案開發時間的考量，許多進階功能和最佳實踐尚未完全整合。  

* Graceful Shutdown
	- 實作全域伺服器狀態管理中心，當其接收關機指令時，協調各管理器依序執行 `shutdown()` 邏輯，確保服務平穩終止與資料持久化，最終完成關閉程序。

* 匹配機制
    - 安全 : 確保匹配過程在玩家加入或從隊列中移除時，都能夠精確同步玩家狀態，並維護資料一致性，從而避免潛在的空指針問題。
    - 效能 : 引入事件驅動架構、更高效的積分排序與匹配算法，以及完善組隊功能來實現，預期將能把匹配效率提升至 O(log N) 的等級並有效節省記憶體的佔用。

* 資料庫
    - 將資料遷移至 MySQL 或 PostgreSQL 等更全面的資料庫伺服器，透過實作連接池與讀寫優化策略發揮其可擴展性和安全性來有效應對高併發與大資料量。

* 物件池
    - 透過以物件池預先配置物件數量，當需要物件時優先從池中借用，用畢後回收，從而避免頻繁的動態記憶體分配與釋放操作，降低 CPU 負擔並減少記憶體碎片化風險。

---
## 作者

* August Jian(sppaugust@gmail.com)

